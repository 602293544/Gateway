# Описание 

Модуль для интеграции устройств Zigbee или BLE для систем автоматизации на базе   [MajorDoMo](https://mjdm.ru/). Для интеграции могут быть использованы программный  продукт  [zigbee2mqtt](https://www.zigbee2mqtt.io) совместно с разлиными вариантами zigbee-донглов, либо  готовый апаратный  шлюз Smart Logic System (SLS) Zigbee BLE gateway. Модуль  позволяет одновременно работать с неограниченным количеством шлюзов или приложений zigbee2mqtt, представляя собой  клиента mqtt и  готовый набор базы данных  поддерживаемых устройств. Использование модуля избавляет пользователя от необходимости прописывания и запоминания  метрик устройств. 

![home](/img/home.png)


# Подготовительные меропрития

Модуль работает через MQTT. 
Установка mosqutto на raspberry или linux:

[ссылка 1](https://robot-on.ru/articles/ystanovka-mqtt-brokera-mosquitto-raspberry-orange-pi)

[ссылка 2](https://smartideal.net/ustanovka-i-zapusk-mqtt-brokera-mosquitto/)

Mosqutto для windows можно скачать [тут](https://mosquitto.org/download/)


Для корректной работы с MajorDoMo необходимо через маркет дополнений установить  модуль [zigbee2mqtt](https://connect.smartliving.ru/tasks/355.html).

После установки mqtt брокера и дополнения для MajorDomo, необходимо на вкладке Сервис прописать нужные настройки:

1) адрес mqtt сервера

2) порт mqtt

3) если необходимо, то логин и пароль mqtt

4) Subscription path - путь для подписки модуля. Если вы используте несколько шлюзов, то каждый из шлюзов необходимо указать через запятую, например так: 
```
ZigBeeCA20/#,zigbee2mqtt/#
```

5) Если zigbee2mqtt установлен на этой же машине нативно, или через docker, можно настроить просмотр лога zigbee2mqtt, указав путь до приложения, например /opt/zigbee2mqtt

6) Для просмотра лога SLS шлюза, необходимо указать его ip адрес в формате 192.168.1.93.

Остальные настройки по желанию.

![settings](/img/settings.jpg)

После нажатия кнопки сохранить, происходит перезапуск цикла zigbee2mqtt. Его статус можно посмотреть в XRAY на вкладке Services. При необходимости, там же его можно перезапустить или остановить.

**Для корректной работы модуля, необходимо на вкладке Сервис нажать кнопку Disable strict mode  - это выключит строгий режим MySQL сервера.**

![settingss](/img/settingss.png)


# Добавление (сопряжение) устройств

Для добавления устройств Zigbee, необходимо на шлюзе включить режим сопряжения. Сделать это можно через Web-интерфейс шлюза SLS, или из модуля MajorDomoo. Режим переключается на вкладке Сервис, либо нажатием на "Сопряжение [имя_шлюза]". Когда индикатор сопряжения горит зеленым, шлюз готов к сопряжению. Для шлюзов на базе Zigbee 3 максимально разрешенное время режима сопряжения составляет 5 минут.

![permit](/img/permit.png)


После включения режима сопряжения, необходимо на устройстве нажать кнопку сброса в соответствии с инструкцией. Узнать, каким образом устройство можно перевести в режим сопряжения можно в каталоге  [zigbee2mqtt](https://www.zigbee2mqtt.io/information/supported_devices.html).


# Управление устройствами с панели управления 
Устройствами, поддерживающими режим упрвления, можно управлять в панели администратора  модуля для MajorDoMo. У таких устройств в  верхней полоске находятся кнопки управления в соответсвии с типом устройства.  Нажатие на соответсвующие пиктограммы изменяет режим. 

![remote](/img/remote.png)

При нажатии на картинку устройства - отправляется команда "toggle", которая изменяет режим на противоположный.


# Управление устройствами через приложения

Интерфейс управления модулем доступен из приложений. Так, установив приложение для телефонов Majordroid, через приложения будет доступен режим простотра и управления устройстами. 

![majordroid1](/img/majordroid1.jpeg)
![majordroid2](/img/majordroid2.jpeg)

Также постоянную странциу дополнения http:/ipaddr/module/zigbee2mqtt.html можно прописать в ибзранном или домашней странций  браузера.

![app](/img/app.png)
![app2](/img/app2.png)



# Привязка устройств к объектам

# Группы

# Binding

# Просмотр логов zigbee2mqtt или SLS ZGW

В дополнении для MajorDoMo  предусмотрен  просмотр log файла программного шлюза. Если zigbee2mqtt  установлен на одном сервере, где установлен MajorDoMo, необходимо на вкладке Настройка в поле Folder path  указать путь, куда установлен zigbee2mqtt. Инструкции по-умполчанию устанавливают в папку /opt/zigbee2mqtt. В результате становится доступен просмотр файл журнала zigbee2mqtt.

![z2mlog](/img/z2mlog.png)

Для аппаратного шлюза SLS в режиме проксирования доступен   просмотр журнала работы. Необходимо на вкладке Настройка в поле SLS ZGW IP adress указать  ip-адресс шлюза.  Просмотр доступен на вкладке SLS log.

![slslog](/img/slslog.png)


# Полезные ссылки

Ссылка на интересный тематический канал в телеграм: https://t.me/zigbeer

Ссылка на репозиторий модуля zigbee2mqtt: http://github.com/directman66/majordomo-zigbee2mqtt/

Топики для управления устройствами через mqtt   https://www.zigbee2mqtt.io/integration/home_assistant.html

Топики для управления  шлюзом через mqtt https://www.zigbee2mqtt.io/information/mqtt_topics_and_message_structure.html#zigbee2mqttbridgelog




