# FAQ

## Вопрос: Какое оборудование необходимо для шлюза на 2530

Ответ: Подборка с Aliexpress для сборки шлюза без пайки:
1.	[Модуль ESP32 16Mb Flash 8Mb SRAM для прошивки по OTA или Модуль ESP32 c 4Mb flash для прошивки без OTA](http://ali.pub/3sy77r)
2.	[Модуль CC2530 без усилителя но с внешней антенной](http://ali.pub/3sy5g6)
3.	[Отладчик СС Debugger для прошивки модуля CC2530](http://ali.pub/3sy6nx)
4.  [Набор проводов](http://ali.pub/3sy6y1)

## Вопрос: Какое оборудование необходимо для шлюза на 2538?
Ответ: Подборка с Aliexpress для сборки шлюза с минимумом пайки (только проводки):
1.	[Модуль ESP32 16Mb Flash 8Mb SRAM для прошивки по OTA или Модуль ESP32 c 4Mb flash для прошивки без OTA](http://ali.pub/485yaa)
2.	[Модуль CC2538 с усилителем СС2592](http://ali.pub/485zeq)
3.	[Программатор J-Link V9](http://ali.pub/485zyk)
4.  [Набор проводов](http://ali.pub/3sy6y1)

## Вопрос: Чем шлюз на базе сс2538 лучше сс2530?
Ответ: Модули на базе сс2530 имеют ограничение по количеству прямых связей (до 10шт, в зависимости от прошивки). сс2530 также имеет ограниченное количество доступной памяти. SDK чика устарел.  Эти проблемы  решены на новых чипах [сс2538](https://github.com/Koenkk/zigbee2mqtt/issues/1568) и [сс2652r](https://github.com/Koenkk/zigbee2mqtt/issues/1429)

## Вопрос: Есть ли отличия в работе шлюза на чипов от TI и NXP?
Ответ: существенно отличается SDK.


## Вопрос: Можно ли приобрести готовое оборудование?
Ответ: В настоящее время распространяются опытные образцы по индивидуальным завявкам. После отладки всего процесса, приобрести готовое оборудование можно будет в интернет магазине. 


## Вопрос: Какую прошивку выбрать для модуля ZigBee
Ответ: Все зависит от того какой у вас модуль и усилитель.
Прошивка должна быть обязательно основана на Z-Stack 3.0.

Для прошивки через CC Debugger:

[Прошивка для модуля CC2530 без усилителя](https://github.com/Koenkk/Z-Stack-firmware/raw/master/coordinator/Z-Stack_3.0.x/bin/CC2530_20190523.zip)

[Прошивка для модуля CC2530 с усилителем СС2591](https://github.com/Koenkk/Z-Stack-firmware/raw/master/coordinator/Z-Stack_3.0.x/bin/CC2530_CC2591_20190523.zip)

[Прошивка для модуля CC2530 с усилителем СС2592](https://github.com/Koenkk/Z-Stack-firmware/raw/master/coordinator/Z-Stack_3.0.x/bin/CC2530_CC2592_20190523.zip)

Для прошивки через J-Link:
[Прошивка для модуля CC2538 с усилителем СС2592](https://github.com/antst/CC2538-ZNP-Coordinator-firmware/files/3678300/CC2538ZNP-UART-without-SBL-cc2592.hex.zip)

## Вопрос: Как прошить ESP32

Для первоначальной прошивки:
```
1. Загрузить архив с прошивальщиком (full) 
2. Подключить ESP32 к компьютеру через USB
3. Запустить прошивку через Flash.bat
4. Иногда батник неверно определяет порт, тогда можно дописать в батник --port COM7
```
Для дальнейшего обновления:
```
1. Загрузить архив с актуальной версией прошивки 
2. Распаковать его в любую папку
3. В веб интерфейсе выбрать на странице Update файл firmware.bin
4. Нажать Start update.
```

## Вопрос: Как прошить CC2530

Ответ:
[Инструкция 1](https://modkam.ru/?p=1188)



## Вопрос: Как прошить CC2538

Ответ:
[Инструкция 1](https://modkam.ru/?p=1188)
[Инструкция 2](https://myzigbee.ru/books/%D0%BF%D1%80%D0%BE%D1%88%D0%B8%D0%B2%D0%BA%D0%B8/page/%D0%BF%D1%80%D0%BE%D1%88%D0%B8%D0%B2%D0%B0%D0%B5%D0%BC-%D1%81%D1%812538-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-j-link)



## Вопрос: Как добавлять устройства.

Ответ: Есть два способа:
1. Включить режим присоединения на странице ZigBee в веб-интерфейсе (кнопка Start Join)
2. Можно послать значение true / false в топик ZigBeeGW/bridge/config/permit_join

## Вопрос: Как добавлять новые устройства Zigbee.

Ответ: SLS Zigbee BLE шлюз автоматически сопрягается с устройствами Zigbee. После сопряжения оно появляется в списке устройств на вкладке Zigbee. Зеленым цветом помечены устройства, уже имеющие конвертер, и с которыми работа уже протестирована. Красным помечены устройства, для  которых конвертер пока отсутсвует. Вы можете помочь с добавлением устройства, предоставив скриншоты страницы устройства и лог сопряжения на страницу [ISSUE](https://github.com/slsys/Gateway/issues) проекта. Открываете новую тему добавление нового устройства с названием устройства.

## Вопрос: Как добавлять новые устройства BLE.

Ответ: SLS Zigbee BLE шлюз также может работать с устройствами BLE. Добавление BLE устройств требует непосредственного наличия устройства. Помочь с добавлением новых, можно только прислав необходимое оборудование.


## Вопрос: Как задавать правила [SimpleBind](/simplebind.md)

Ответ: Есть два формата записи:
1.	DstDeviceId
2.	Cond, DstDeviceId, DstStateName, DstStateValue (Разделение запятыми, пробелы допускаются)
где:
•	Cond - значение при котором будет выполняться правило
•	DstDeviceId - Идентификатор устройства которому будем отправлять команду
•	DstStateName - Имя состояния которое будем отправлять
•	DstStateValue - Значение которое будем отправлять
Перед значением в поле Cond можно использовать знаки сравнения. (>, <, =, !, >=, <=, !=, <>)
Можно использовать несколько правил, разделяя их точкой с запятой.
Примеры:
•	single, lamp_1, state, TOGGLE - Для кнопки, при одиночном нажатии переключает режим lamp_1
•	ON, 0x00158D00007350D9, state, OFF; OFF, 0xABCD, state, ON - Для выключателя, инвертирует режим для реле
•	single, door_lock, state, LOCK; double, door_lock, state, UNLOCK - Закрывает замок при клике, открывает при двойном
•	torsher_lamp - Передает в torsher_lamp текущее состояние
•	<40, humidifier, state, ON; >60, humidifier, state, OFF - Для датчика влажности, включает увлажнитель если влажность меньше 40% и выключает если больше 60%

Пример:
left, PTVO, state_bottom_left, TOGGLE; right, PTVO, state_bottom_right, TOGGLE

## Вопрос: Как задать цвет лампочке или RGB контроллеру
Ответ:
Необходимо отправить в состояние color json объект содержащий один из вариантов задания цвета:
1. В родном формате CIE 1931: {"x": 0.8, "y": 0.04}
2. В формате RGB: {"r": 0, "g": 255, "b": 0}
3. В формате RGB HEX: {"hex": "#RRGGBB"}
4. Тон, насыщенность: {"hue": 23525, "saturation": 80}
5. Тон: {"hue": 1665}
6. Насыщенность: {"saturation": 220}

Пример:
Отправка в топик ZigBeeGW/0x00158D00011D8CB1/set значения: {"color":{"r":0,"g":255,"b":0}}


## Вопрос: Как задать цветовую температуру лампочке

Ответ:
Необходимо отправить в состояние color_temp значение в Майред единицах измерения.
Формула для преобразования: M = 1000000 / K где K - температура в Кельвинах.

Пример:
Цветовая температура 4000К, задаем в ZigBeeGW/lamp_1/set/color_temp значение 250

## Вопрос: Как управлять аппаратными светодиодами?
Ответ:
Необходимо отправить в JSON значение в топик ZigBeeGW/led следующего содержания:
{"mode":"manual","hex":"#FFFFFF"}

mode - устанавливает режим, допустимы значения off, manual и auto
hex - значение цвета в RGB Hex формате.


## Вопрос: Что означают цифры в этапах сопряжения
Ответ:

0 - получен анонс, запускается интервью

1 - получено описание устройства

2 - получено количество активных эндпоинтов

3 - получены кластеры устройства

4- получена модель


Многие устройствя Xiaomi  сами репортят модель, поэтому работают  без завершения всего цикла интервью.

## Вопрос: Как добавить новое неподдерживаемое устройство Zigbee?

Ответ: Многие устройства могут быть добавлены удаленно разработчиками проекта SLS ZGW. Вероятность добавления новых устройств увеличивается при  наличии конвертера в  [zigbee2mqtt](https://github.com/Koenkk/zigbee-herdsman-converters/blob/master/converters/fromZigbee.js)

Также неоспоримым приемуществом для добавления нового устройства является протокол взаимодействия в z2m. Его можно получить из zigbee2mqtt в режиме дебага zigbee  следующей комбинацией:

```
cd /opt/zigbee2mqtt 
DEBUG=zigbee-herdsman:zStack:* npm start
```

Далее необходимо выполнить нужные действия с устройством и сохранить вывод  экрана. Данные сообщения можно добавить в [issue](https://github.com/slsys/Gateway/issues) или с помощью сервиса [pastebin](https://pastebin.com)


## Вопрос: Как получить журнал работы через UART.

Ответ: Иногда  приходится сталкиваться с перезагрузками, причину которых выявить можно только подключив шлюз через uart.
В подключенный последовательно порт прошивка SLS ZGW посылает примерно ту же информацию, что и в журнал web. Но в последнем вы не увидите ошибку, которая вызывала перезагрузку.

#### Ubuntu linux
В операционной системе Linux драйвер ch340 обычно включен в модуль ядра. Поэтому после подключения шлюза, в системном логе по команда dmesg можно увидеть номер порта шлюза в системе.  Обычно это /dev/ttyACM1 или /dev/ttyUSB0.

Для того, чтобы при чтении данных с порта не отправлять полученные с него же данные обратно в порт, необходимо отправить команду 

```
stty -F /dev/ttyUSB0 115200 -cstopb -oddp -opost raw -echo
```

Далее запускаем команду записи данных порта в файл
```
cat /dev/ttyUSB0 > slslog.txt
```


#### Windows
В операционной системе Windows, подключенный с распаенным ch340 шлюз при наличии установленного драйвера будет виден как последовательный COM порт. Подключившись к нему через [putty](https://www.putty.org), можно наблюдать за журналом работы шлюза.

Возможно ваш понадобится [драйвер](https://github.com/HobbyComponents/CH340-Drivers).


Для того, чтобы можно было журнал сохранить файл, необходимо:

1. Выбираем Session ->Logging ставим чекпоинты как показано на рисунке (выбираем All session output):


![2-putty](/img/2-putty.jpg)

2. В поле «Log file name » указываем путь в папку где будут хранится файлы  и название файла пишем &H-&Y&M&D-&T.log:


![3-putty](/img/3-putty.jpg)

&H-&Y&M&D-&T.log    —  Это :

&H –  Имя хоста (IP Address )

&Y&M&D –  Год,Месяц, День созданного файла

&T – Время подключения к устройству.

Название файла будет выглядеть вот так : 192.168.1.1-20151116-135505.log

Соответственно файл сохранится по пути : D:\


## на какой скорости ESP32 общается с СС2538

Ответ: скорость 115200
